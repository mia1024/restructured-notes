#!/bin/bash

cd "${0%/*}"
if [ -d node_modules ]; then
  rm -rf node_modules
fi
yarn
yarn compile-dependencies
if [ $? -ne 0 ]; then
  echo "yarn compile-dependencies failed. Trying electron-rebuild instead..."
  $(npm bin)/electron-rebuild
  if [ $? -ne 0 ]; then
    echo "Cannot compile the binary"
    exit 1
  fi
fi

# Canvas is required by jsdom for testing
npm rebuild canvas --target=8.3.3 --runtime=electron --dist-url='https://atom.io/download/electron' --update-binary
